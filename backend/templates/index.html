<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Zapatex - Venta</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
  </style>
</head>
<body>
  <h1>Venta Zapatex</h1>

  <label for="buscar">Buscar producto:</label>
  <input type="text" id="buscar" placeholder="Escribe producto..." />

  <div id="sucursales-list"></div>

  <div class="separador"></div>

  <strong>Casa Matriz</strong>
  <div id="casa-matriz"></div>

  <label for="sucursal">Sucursales:</label>
  <select id="sucursal"></select>

  <div id="cantidad-total">
    <div>
      <label for="cantidad">Cantidad:</label>
      <input type="number" id="cantidad" min="1" value="1">
    </div>
    <button id="calcular">Calcular Total USD</button>
  </div>

  <p id="total"></p>

  <button id="vender">Venta</button>

  <div id="alerta-stock"></div>

  <script>
  let productos = [];

  async function cargarDatos() {
    const res = await fetch('/api/stock');
    const data = await res.json();

    productos = [...data.sucursales];
    if (data.casa_matriz) {
      productos.push(data.casa_matriz);
    }

    mostrarProductos();  // Mostramos todo al cargar
  }

  function mostrarProductos(filtro = '') {
    const lista = document.getElementById('sucursales-list');
    const select = document.getElementById('sucursal');
    const matrizDiv = document.getElementById('casa-matriz');

    lista.innerHTML = '';
    select.innerHTML = '';
    matrizDiv.innerHTML = '';
    document.getElementById('alerta-stock').style.display = 'none';

    // Filtrar por nombre de producto si se escribió algo
    const filtroLower = filtro.toLowerCase();
    const productosFiltrados = filtro
      ? productos.filter(p => p.producto.toLowerCase().includes(filtroLower))
      : productos;

    // Agrupar por producto
    const productosAgrupados = {};
    productosFiltrados.forEach(p => {
      if (!productosAgrupados[p.producto]) {
        productosAgrupados[p.producto] = [];
      }
      productosAgrupados[p.producto].push(p);
    });

    // Mostrar por producto
    for (const nombreProducto in productosAgrupados) {
      const encabezado = document.createElement('h3');
      encabezado.textContent = nombreProducto;
      lista.appendChild(encabezado);

      productosAgrupados[nombreProducto].forEach(s => {
        const div = document.createElement('div');
        div.className = 'sucursal';
        div.textContent = `${s.sucursal}: Cant: ${s.cantidad} | Precio: ${s.precio}`;
        lista.appendChild(div);

        // Agregar al select si no es casa matriz
        const opt = document.createElement('option');
          opt.value = s.sucursal;
          opt.textContent = s.sucursal;
          select.appendChild(opt);

        if (s.cantidad === 0) {
          const alerta = document.getElementById('alerta-stock');
          alerta.style.display = 'block';
          alerta.textContent = `Stock bajo en ${s.sucursal}`;
        }
      });

      // Separador visual
      const sep = document.createElement('hr');
      lista.appendChild(sep);
    }
  }

  document.getElementById('buscar').addEventListener('input', e => {
    mostrarProductos(e.target.value);
  });

  document.getElementById('calcular').addEventListener('click', async () => {
  const cantidad = parseInt(document.getElementById('cantidad').value);
  const nombreProducto = document.querySelector('#sucursales-list h3')?.textContent;

  if (!nombreProducto) {
    alert('Primero busca y selecciona un producto válido');
    return;
  }

  // Buscar todas las sucursales con ese producto
  const coincidencias = productos.filter(p =>
    p.producto.toLowerCase() === nombreProducto.toLowerCase() &&
    p.cantidad > 0
  );

  const stockTotal = coincidencias.reduce((sum, s) => sum + s.cantidad, 0);

  if (cantidad > stockTotal) {
    alert(`No hay suficiente stock disponible. Solo hay ${stockTotal} unidades en total.`);
    return;
  }

  // Calcular total tomando desde varias sucursales
  let restante = cantidad;
  let totalCLP = 0;
  let detalle = [];

  for (const s of coincidencias) {
    if (restante === 0) break;

    const usar = Math.min(s.cantidad, restante);
    totalCLP += usar * s.precio;
    detalle.push(`${usar} u. desde ${s.sucursal}`);
    restante -= usar;
  }

  document.getElementById('vender').addEventListener('click', async () => {
  const cantidad = parseInt(document.getElementById('cantidad').value);
  const nombreProducto = document.querySelector('#sucursales-list h3')?.textContent;

  if (!nombreProducto) {
    alert('Selecciona un producto válido primero');
    return;
  }

  const confirmacion = confirm('¿Confirmar pago con Transbank?');
  if (!confirmacion) return;

  const res = await fetch('/venta', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      producto: nombreProducto,
      cantidad: cantidad
    })
  });

  const data = await res.json();

  if (res.ok) {
    alert('✅ Pago exitoso con Transbank.\nStock actualizado.');
    await cargarDatos(); // recargar datos
    document.getElementById('total').textContent = '';
  } else {
    alert('❌ Error en venta: ' + (data.error || 'Desconocido'));
  }
});

  // Convertir a USD
  const res = await fetch(`/api/usd?clp=${totalCLP}`);
  const data = await res.json();

  document.getElementById('total').innerHTML =
    `Total: ${totalCLP} CLP | USD: ${data.usd}<br><small>${detalle.join(', ')}</small>`;
});


  document.addEventListener('DOMContentLoaded', cargarDatos);

</script>

<script src="{{ url_for('static', filename='script.js') }}"></script>

</body>
</html>
